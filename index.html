<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klas Layout Tool - Cloud v12</title>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-dark: #121212;
            --panel-dark: #1e1e1e;
            --accent: #bb86fc;
            --text: #e0e0e0;
            --desk-bg: #2c2c2c;
            --border: #333;
            --pinned: #03dac6;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-dark); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        #mobile-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        @media (max-width: 768px) { #mobile-overlay { display: flex; } }

        aside { width: 280px; background-color: var(--panel-dark); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 2000; overflow-y: auto; }
        aside.right { border-right: none; border-left: 1px solid var(--border); }
        main { flex-grow: 1; position: relative; padding: 20px; display: flex; flex-direction: column; }

        #classroom-area { flex-grow: 1; border: 2px dashed var(--border); border-radius: 12px; position: relative; background-color: #181818; overflow: hidden; }

        /* Auth styling met icoon */
        .auth-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .user-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .user-info img { width: 30px; border-radius: 50%; }
        .logout-icon { cursor: pointer; opacity: 0.6; transition: 0.2s; font-size: 1.2em; padding: 5px; }
        .logout-icon:hover { opacity: 1; color: #cf6679; }

        /* Tafels */
        .desk { width: 100px; height: 70px; background: var(--desk-bg); border: 1.5px solid var(--accent); position: absolute; display: flex; align-items: center; justify-content: center; cursor: move; font-size: 13px; box-sizing: border-box; border-radius: 6px; user-select: none; padding: 5px; }
        .desk.teacher { background: #333; border: 2px solid white; color: white; font-weight: bold; width: 140px; height: 80px; }
        .desk.rotated { width: 70px; height: 100px; }
        .desk.rotated.teacher { width: 80px; height: 140px; }
        .desk.empty { border: 1.5px dashed #555; color: #666; }
        .desk.is-pinned { border-color: var(--pinned); }

        .icon-btn { position: absolute; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); z-index: 10; opacity: 0.2; transition: opacity 0.2s; }
        .desk:hover .icon-btn { opacity: 1; }
        .pin-btn { top: 4px; left: 4px; background: #444; color: #aaa; }
        .pin-btn.active { background: var(--pinned); color: black; opacity: 1; }
        .rotate-btn { top: 4px; right: 4px; background: var(--accent); color: black; }
        .desk-label { pointer-events: none; width: 100%; text-align: center; word-wrap: break-word; }

        h2 { color: var(--accent); margin: 0 0 10px 0; font-size: 1.1em; }
        textarea { flex-grow: 1; background: #252525; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; resize: none; margin-bottom: 15px; min-height: 150px; }
        .button-group { display: flex; flex-direction: column; gap: 8px; }
        button { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-secondary { background: #333; color: white; }
        .btn-success { background: #03dac6; color: #000; }
        .btn-danger { background: #cf6679; color: #000; }
        
        .saved-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; }
        .item-row span { cursor: pointer; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-row i { color: #cf6679; cursor: pointer; padding: 0 5px; font-style: normal; font-weight: bold; }

        .active-class-name { font-size: 0.8em; color: var(--accent); margin-bottom: 10px; font-style: italic; }

        .print-mode #classroom-area { background: white !important; }
        .print-mode .desk { background: white !important; color: black !important; border: 1px solid black !important; }
        .print-mode .icon-btn { display: none !important; }
    </style>
</head>
<body>

    <div id="mobile-overlay">
        <h1>üñ•Ô∏è Desktop Vereist</h1>
        <p>Gebruik een computer om je klassen te beheren.</p>
    </div>

    <aside>
        <div class="auth-section" id="auth-ui">
            <button class="btn-primary" onclick="login()">Log in met Google</button>
        </div>

        <h2>Mijn Klas Templates</h2>
        <div id="custom-templates-list" class="saved-list"></div>
        <button class="btn-secondary" style="margin-top:10px;" onclick="saveAsCustomTemplate()">+ Opstelling opslaan</button>

        <h2 style="margin-top:30px;">Standaard Layouts</h2>
        <div class="button-group">
            <button class="btn-secondary" onclick="loadTemplate('rijen')">Rijen</button>
            <button class="btn-secondary" onclick="loadTemplate('duos')">Duos</button>
            <button class="btn-secondary" onclick="loadTemplate('groepjes')">Groepjes</button>
        </div>

        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
        <div class="button-group">
            <button class="btn-primary" onclick="createDesk()">+ Leerling Tafel</button>
            <button class="btn-secondary" onclick="createDesk(300, 20, 'BUREAU LERAAR', false, false, true)">+ Leraar Bureau</button>
        </div>
    </aside>

    <main>
        <div id="classroom-area"></div>
    </main>

    <aside class="right">
        <h2>Mijn Klassen</h2>
        <div id="active-class-display" class="active-class-name">Geen klas geselecteerd</div>
        <div id="classes-list" class="saved-list" style="margin-bottom: 20px;"></div>
        <button class="btn-success" onclick="saveCurrentClass()">+ Sla huidige klas op</button>

        <h2 style="margin-top:30px;">Leerlingen</h2>
        <textarea id="nameList" oninput="saveData()" placeholder="Namen hier..."></textarea>
        
        <div class="button-group">
            <button class="btn-success" onclick="distributeNames()">Verdeel Namen</button>
            <button class="btn-secondary" onclick="exportLayout()">Exporteer PNG</button>
            <button class="btn-secondary" onclick="clearDeskTexts()">Maak Tafels Leeg</button>
            <button class="btn-danger" onclick="removeAllDesks()">Reset Lokaal</button>
        </div>
    </aside>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAv1D8oSmUXbZpKMINsbYPpi6p5qGv8fX0",
            authDomain: "klasplattegrond.firebaseapp.com",
            projectId: "klasplattegrond",
            storageBucket: "klasplattegrond.firebasestorage.app",
            messagingSenderId: "1035245870159",
            appId: "1:1035245870159:web:81b2d39a5dac1b71ba9e3a"
    };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let activeClassId = null;

        const classroom = document.getElementById('classroom-area');
        const nameInput = document.getElementById('nameList');

        // --- AUTH ---
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { if(confirm("Wil je uitloggen?")) auth.signOut(); }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            const authUi = document.getElementById('auth-ui');
            if (user) {
                authUi.innerHTML = `
                    <div class="user-header">
                        <div class="user-info">
                            <img src="${user.photoURL}">
                            <span>Hoi, ${user.displayName.split(' ')[0]}</span>
                        </div>
                        <span class="logout-icon" onclick="logout()" title="Uitloggen">üö™</span>
                    </div>`;
                loadCustomTemplates();
                loadClasses();
            } else {
                authUi.innerHTML = `<button class="btn-primary" onclick="login()">Log in met Google</button>`;
                classroom.innerHTML = '';
                nameInput.value = '';
                document.getElementById('custom-templates-list').innerHTML = '';
                document.getElementById('classes-list').innerHTML = '';
                activeClassId = null;
                document.getElementById('active-class-display').innerText = "Geen klas geselecteerd";
            }
        });

        // --- TAFEL LOGICA (Inclusief Docent Fix) ---
        function createDesk(x = 50, y = 50, text = 'Leeg', isRotated = false, isPinned = false, isTeacher = false) {
            const desk = document.createElement('div');
            const finalText = isTeacher ? 'BUREAU LERAAR' : text;
            
            desk.className = `desk ${finalText === 'Leeg' ? 'empty' : ''} ${isRotated ? 'rotated' : ''} ${isPinned ? 'is-pinned' : ''} ${isTeacher ? 'teacher' : ''}`;
            desk.style.left = x + 'px'; desk.style.top = y + 'px';

            const label = document.createElement('span');
            label.className = 'desk-label'; label.innerText = finalText;
            desk.appendChild(label);

            const rotBtn = document.createElement('div');
            rotBtn.className = 'icon-btn rotate-btn'; rotBtn.innerHTML = '‚ü≥';
            rotBtn.onclick = (e) => { e.stopPropagation(); desk.classList.toggle('rotated'); saveData(); };
            desk.appendChild(rotBtn);

            if (!isTeacher) {
                const pinBtn = document.createElement('div');
                pinBtn.className = `icon-btn pin-btn ${isPinned ? 'active' : ''}`;
                pinBtn.innerHTML = 'üìå';
                pinBtn.onclick = (e) => { e.stopPropagation(); desk.classList.toggle('is-pinned'); pinBtn.classList.toggle('active'); saveData(); };
                desk.appendChild(pinBtn);
            }

            desk.ondblclick = () => { if(confirm("Tafel verwijderen?")) { desk.remove(); saveData(); } };
            makeDraggable(desk);
            classroom.appendChild(desk);
        }

        function makeDraggable(element) {
            let p1, p2, p3, p4;
            element.onmousedown = (e) => {
                if (e.target.classList.contains('icon-btn')) return;
                e.preventDefault();
                element.style.zIndex = 1000;
                p3 = e.clientX; p4 = e.clientY;
                document.onmousemove = (e) => {
                    p1 = p3 - e.clientX; p2 = p4 - e.clientY;
                    p3 = e.clientX; p4 = e.clientY;
                    element.style.left = Math.max(0, element.offsetLeft - p1) + "px";
                    element.style.top = Math.max(0, element.offsetTop - p2) + "px";
                };
                document.onmouseup = () => { element.style.zIndex = 10; document.onmousemove = null; saveData(); };
            };
        }

        // --- CLOUD OPSLAG ---
        async function saveData() {
            if (!currentUser || !activeClassId) return;
            const desksData = Array.from(document.querySelectorAll('.desk')).map(d => ({
                x: parseInt(d.style.left), y: parseInt(d.style.top),
                t: d.querySelector('.desk-label').innerText, 
                r: d.classList.contains('rotated'), p: d.classList.contains('is-pinned'),
                tc: d.classList.contains('teacher')
            }));
            await db.collection('users').doc(currentUser.uid).collection('classes').doc(activeClassId).update({
                names: nameInput.value,
                layout: desksData
            }).catch(err => console.error("Auto-save error:", err));
        }

        async function saveCurrentClass() {
            if (!currentUser) return alert("Log eerst in!");
            const name = prompt("Klasnaam (bijv. 1B):");
            if (!name) return;
            const desksData = Array.from(document.querySelectorAll('.desk')).map(d => ({
                x: parseInt(d.style.left), y: parseInt(d.style.top),
                t: d.querySelector('.desk-label').innerText, 
                r: d.classList.contains('rotated'), p: d.classList.contains('is-pinned'),
                tc: d.classList.contains('teacher')
            }));
            const docRef = await db.collection('users').doc(currentUser.uid).collection('classes').add({
                className: name,
                names: nameInput.value,
                layout: desksData
            });
            activeClassId = docRef.id;
            document.getElementById('active-class-display').innerText = "Actief: " + name;
            loadClasses();
        }

        async function loadClasses() {
            const list = document.getElementById('classes-list');
            const snap = await db.collection('users').doc(currentUser.uid).collection('classes').get();
            list.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `<span onclick="applyClass('${doc.id}')">${data.className}</span><i onclick="deleteItem('classes', '${doc.id}')">‚úï</i>`;
                list.appendChild(div);
            });
        }

        async function applyClass(id) {
            const doc = await db.collection('users').doc(currentUser.uid).collection('classes').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                activeClassId = id;
                document.getElementById('active-class-display').innerText = "Actief: " + data.className;
                nameInput.value = data.names || '';
                classroom.innerHTML = '';
                if(data.layout) data.layout.forEach(d => createDesk(d.x, d.y, d.t, d.r, d.p, d.tc || false));
            }
        }

        async function saveAsCustomTemplate() {
            if (!currentUser) return alert("Log in!");
            const name = prompt("Template naam:");
            if (!name) return;
            const layout = Array.from(document.querySelectorAll('.desk')).map(d => ({
                x: parseInt(d.style.left), y: parseInt(d.style.top),
                r: d.classList.contains('rotated'), tc: d.classList.contains('teacher')
            }));
            await db.collection('users').doc(currentUser.uid).collection('templates').add({ name, layout });
            loadCustomTemplates();
        }

        async function loadCustomTemplates() {
            const list = document.getElementById('custom-templates-list');
            const snap = await db.collection('users').doc(currentUser.uid).collection('templates').get();
            list.innerHTML = '';
            snap.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `<span onclick='applyTemplate(${JSON.stringify(data.layout)})'>${data.name}</span><i onclick="deleteItem('templates', '${doc.id}')">‚úï</i>`;
                list.appendChild(div);
            });
        }

        function applyTemplate(layout) {
            classroom.innerHTML = '';
            layout.forEach(d => createDesk(d.x, d.y, 'Leeg', d.r, false, d.tc));
            saveData();
        }

        async function deleteItem(coll, id) {
            if(confirm("Verwijderen?")) {
                await db.collection('users').doc(currentUser.uid).collection(coll).doc(id).delete();
                if(id === activeClassId) {
                    activeClassId = null;
                    document.getElementById('active-class-display').innerText = "Geen klas geselecteerd";
                }
                coll === 'classes' ? loadClasses() : loadCustomTemplates();
            }
        }

        // --- HELPERS ---
        function distributeNames() {
            const all = nameInput.value.split('\n').map(n => n.trim()).filter(n => n !== '');
            const desks = Array.from(document.querySelectorAll('.desk')).filter(d => !d.classList.contains('teacher'));
            const pinned = desks.filter(d => d.classList.contains('is-pinned')).map(d => d.querySelector('.desk-label').innerText).filter(n => n !== 'Leeg');
            const toShuffle = all.filter(n => !pinned.includes(n));
            const free = desks.filter(d => !d.classList.contains('is-pinned'));
            free.forEach(d => { d.querySelector('.desk-label').innerText = 'Leeg'; d.classList.add('empty'); });
            free.sort(() => Math.random() - 0.5);
            toShuffle.forEach((n, i) => { if (i < free.length) { free[i].querySelector('.desk-label').innerText = n; free[i].classList.remove('empty'); } });
            saveData();
        }

        function loadTemplate(type) {
            classroom.innerHTML = '';
            createDesk(330, 20, 'BUREAU LERAAR', false, false, true);
            if (type === 'rijen') for (let r = 0; r < 4; r++) for (let c = 0; c < 6; c++) createDesk(100+(c*110), 120+(r*90));
            if (type === 'duos') for (let r = 0; r < 5; r++) for (let k = 0; k < 3; k++) { createDesk(80+(k*250), 120+(r*90)); createDesk(180+(k*250), 120+(r*90)); }
            if (type === 'groepjes') for (let r = 0; r < 3; r++) for (let c = 0; c < 2; c++) { 
                let x = 150+(c*300), y = 120+(r*160); createDesk(x,y); createDesk(x+100,y); createDesk(x,y+70); createDesk(x+100,y+70); 
            }
            saveData();
        }

        function clearDeskTexts() { document.querySelectorAll('.desk:not(.teacher)').forEach(d => { d.querySelector('.desk-label').innerText = 'Leeg'; d.classList.add('empty'); }); saveData(); }
        function removeAllDesks() { if(confirm("Lokaal leegmaken?")) { classroom.innerHTML = ''; activeClassId = null; document.getElementById('active-class-display').innerText = "Geen klas geselecteerd"; saveData(); } }

        async function exportLayout() {
            document.body.classList.add('print-mode');
            await new Promise(r => setTimeout(r, 150));
            html2canvas(classroom, { backgroundColor: 'white' }).then(c => {
                const l = document.createElement('a'); l.download = 'klasopstelling.png'; l.href = c.toDataURL(); l.click();
            }).finally(() => document.body.classList.remove('print-mode'));
        }
    </script>
</body>
</html>
